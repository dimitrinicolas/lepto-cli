#!/usr/bin/env node

const fs = require('fs');
const path = require('path');
const chalk = require('chalk');
const minimist = require('minimist')

const lepto = require('../../lepto/src/lepto.js');
const loadConfig = require('../../lepto/src/load-config.js');
// TODO all config watching inside lepto-cli

const argv = minimist(process.argv.slice(2), {
  alias: {
    i: 'input',
    o: 'output',
    w: 'watch',
    c: 'config',
    l: 'logLevel'
  }
});

let loadedConfig = null;

if (argv.config) {
  const loaded = loadConfig(path.resolve(argv.config), { cli: true });
  if (loaded.success) {
    loadedConfig = loaded;
  }
  else {
    console.log(chalk.red.bold('Lepto -', loaded.msg));
    return;
  }
}
else {
  const jsonConfigResult = loadConfig(path.resolve(process.cwd(), './lepto.config.json'), { cli: true });
  if (jsonConfigResult.success) {
    loadedConfig = newConfigResult;
  }
  else {
    const jsConfigResult = loadConfig(path.resolve(process.cwd(), './lepto.config.js'), { cli: true });
    if (jsConfigResult.success) {
      loadedConfig = jsConfigResult;
    }
  }
}

if (!loadedConfig) {
  console.log(chalk.red.bold('Lepto - No config file found'));
  return;
}

const cliConfig = {};
const argvOpts = ['input', 'output', 'watch', 'logLevel'];
for (let item of argvOpts) {
  if (typeof argv[item] !== 'undefined') {
    cliConfig[item] = argv[item];
  }
}

lepto(loadedConfig, cliConfig);
